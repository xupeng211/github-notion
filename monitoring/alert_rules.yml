groups:
  - name: github-notion-sync-alerts
    rules:
      # 服务可用性告警
      - alert: ServiceDown
        expr: up{job="github-notion-sync"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "GitHub-Notion 同步服务不可用"
          description: "服务已离线超过 1 分钟"

      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(events_total{result="fail"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "事件处理错误率过高"
          description: "过去 5 分钟内错误率超过 10%: {{ $value }}"

      # 死信队列积压告警
      - alert: DeadletterQueueBacklog
        expr: deadletter_size > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "死信队列积压严重"
          description: "死信队列中有 {{ $value }} 条记录等待重试"

      # 死信队列严重积压告警
      - alert: DeadletterQueueCritical
        expr: deadletter_size > 200
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "死信队列严重积压"
          description: "死信队列中有 {{ $value }} 条记录，需要立即处理"

      # 处理延迟告警
      - alert: HighProcessingLatency
        expr: process_p95_ms > 5000
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "事件处理延迟过高"
          description: "95分位处理延迟超过 5 秒: {{ $value }}ms"

      # Notion API 错误率告警
      - alert: NotionAPIErrors
        expr: rate(notion_api_calls_total{status="error"}[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Notion API 错误率过高"
          description: "过去 5 分钟内 Notion API 错误率超过 5%"

      # 速率限制告警
      - alert: RateLimitHits
        expr: rate(rate_limit_hits_total[5m]) > 0.01
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "触发速率限制"
          description: "服务正在触发速率限制，可能影响性能"

      # 磁盘空间告警
      - alert: LowDiskSpace
        expr: node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} * 100 < 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "磁盘空间不足"
          description: "根分区剩余空间少于 10%"

      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过 80%: {{ $value }}%"

  - name: github-notion-sync-health
    rules:
      # 健康检查失败告警
      - alert: HealthCheckFailed
        expr: up{job="github-notion-sync-health"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "健康检查失败"
          description: "服务健康检查端点无法访问"

      # API 连接问题告警（需要自定义指标）
      - alert: APIConnectionIssues
        expr: increase(webhook_errors_total[5m]) > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "API 连接异常"
          description: "过去 5 分钟内出现多次 API 连接错误" 