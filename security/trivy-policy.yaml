# ğŸ›¡ï¸ Trivyå®‰å…¨æ‰«æç­–ç•¥
# å®šä¹‰æ¼æ´æ‰«æçš„é€šè¿‡æ ‡å‡†å’Œè±å…è§„åˆ™

apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-security-policy
  namespace: security
data:
  # æ‰«æç­–ç•¥é…ç½®
  policy.yaml: |
    # ä¸¥é‡æ€§çº§åˆ«é˜ˆå€¼
    severity_thresholds:
      critical: 0      # ä¸å…è®¸ä»»ä½•å…³é”®æ¼æ´
      high: 5          # æœ€å¤šå…è®¸5ä¸ªé«˜å±æ¼æ´ï¼ˆéœ€åœ¨ç™½åå•ä¸­ï¼‰
      medium: 20       # æœ€å¤šå…è®¸20ä¸ªä¸­å±æ¼æ´
      low: 50          # æœ€å¤šå…è®¸50ä¸ªä½å±æ¼æ´
    
    # åŒ…ç±»å‹ç­–ç•¥
    package_policies:
      python-pkg:
        # PythonåŒ…å¿…é¡»æœ‰ä¿®å¤ç‰ˆæœ¬æˆ–åœ¨ç™½åå•ä¸­
        require_fix_or_allowlist: true
        max_critical: 0
        max_high: 3
      
      debian:
        # ç³»ç»ŸåŒ…å…è®¸æ›´å®½æ¾çš„ç­–ç•¥
        require_fix_or_allowlist: false
        max_critical: 5
        max_high: 15
    
    # è‡ªåŠ¨è±å…æ¡ä»¶
    auto_exemptions:
      - condition: "status == 'will_not_fix'"
        reason: "ä¸Šæ¸¸ä¸ä¼šä¿®å¤çš„æ¼æ´"
        max_severity: "high"
      
      - condition: "status == 'fix_deferred'"
        reason: "ä¿®å¤å»¶æœŸçš„æ¼æ´"
        max_severity: "medium"
    
    # å¼ºåˆ¶å¤±è´¥æ¡ä»¶
    fail_conditions:
      - "severity == 'critical' and package_type == 'python-pkg'"
      - "severity == 'high' and package_type == 'python-pkg' and not in_allowlist"
    
    # æŠ¥å‘Šé…ç½®
    reporting:
      format: ["json", "table"]
      include_fixed: true
      include_unfixed: true
      
  # æ‰«æé…ç½®
  scan.yaml: |
    # æ‰«æç›®æ ‡é…ç½®
    targets:
      - type: "image"
        severity: ["CRITICAL", "HIGH", "MEDIUM", "LOW"]
        pkg_types: ["python-pkg", "debian"]
        
    # è¾“å‡ºé…ç½®
    output:
      format: "json"
      template: "@contrib/html.tpl"
      
    # ç¼“å­˜é…ç½®
    cache:
      backend: "fs"
      ttl: "24h"
