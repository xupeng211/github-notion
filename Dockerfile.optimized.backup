# ğŸš€ ä¼˜åŒ–çš„ç”Ÿäº§ç¯å¢ƒ Dockerfile
# ä¸“ä¸º CI/CD ç¯å¢ƒä¼˜åŒ–ï¼Œè§£å†³å¸¸è§æ„å»ºé—®é¢˜

FROM python:3.11-slim

WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡ - ä¼˜åŒ–æ„å»ºå’Œè¿è¡Œ
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_DEFAULT_TIMEOUT=100 \
    DEBIAN_FRONTEND=noninteractive

# å®‰è£…ç³»ç»Ÿä¾èµ– - æœ€å°åŒ–å®‰è£…
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# åˆ›å»ºé root ç”¨æˆ· - å®‰å…¨æœ€ä½³å®è·µ
RUN useradd -m -u 1000 appuser && \
    mkdir -p /app/data /app/logs && \
    chown -R appuser:appuser /app

# å‡çº§ pip - ç¡®ä¿æœ€æ–°ç‰ˆæœ¬
RUN pip install --upgrade pip setuptools wheel

# å¤åˆ¶å¹¶å®‰è£…ä¾èµ– - åˆ†å±‚ç¼“å­˜ä¼˜åŒ–
COPY requirements.txt .

# å®‰è£… Python ä¾èµ– - ç½‘ç»œä¼˜åŒ–å’Œé‡è¯•æœºåˆ¶
RUN pip install --no-cache-dir \
    --timeout 300 \
    --retries 3 \
    --prefer-binary \
    --index-url https://pypi.org/simple/ \
    --trusted-host pypi.org \
    -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
ENV PATH="/home/appuser/.local/bin:$PATH"

# å¥åº·æ£€æŸ¥ - ä½¿ç”¨ç¯å¢ƒå˜é‡
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:${APP_PORT:-8000}/health || exit 1

# æš´éœ²ç«¯å£ - ä½¿ç”¨ç¯å¢ƒå˜é‡
EXPOSE ${APP_PORT:-8000}

# å¯åŠ¨å‘½ä»¤ - çµæ´»é…ç½®
CMD ["sh", "-c", "python -m uvicorn app.server:app --host 0.0.0.0 --port ${APP_PORT:-8000}"]
