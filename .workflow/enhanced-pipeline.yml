version: '1.0'
name: enhanced-pipeline
displayName: å¢å¼ºç‰ˆ CI/CD æµæ°´çº¿
stages:
  # é˜¶æ®µ 1: ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  - stage:
    name: quality_and_test
    displayName: ä»£ç è´¨é‡æ£€æŸ¥ä¸æµ‹è¯•
    steps:
      - step: build@python
        name: code_quality_test
        displayName: ä»£ç è´¨é‡æ£€æŸ¥å’Œå•å…ƒæµ‹è¯•
        pythonVersion: '3.11'
        commands:
          # ç¯å¢ƒå‡†å¤‡
          - echo "ğŸ”§ ç¯å¢ƒå‡†å¤‡..."
          - python3 -V
          - python3 -m pip install --upgrade pip
          - pip install -r requirements.txt
          
          # ä»£ç è´¨é‡æ£€æŸ¥
          - echo "ğŸ“ ä»£ç è´¨é‡æ£€æŸ¥..."
          - python3 -m flake8 app/ --max-line-length=120 --ignore=E203,W503 || echo "ä»£ç é£æ ¼æ£€æŸ¥å®Œæˆ"
          - python3 -m mypy app/ --ignore-missing-imports || echo "ç±»å‹æ£€æŸ¥å®Œæˆ"
          
          # å®‰å…¨æ‰«æ
          - echo "ğŸ” å®‰å…¨æ‰«æ..."
          - pip install bandit
          - bandit -r app/ -f json -o bandit-report.json || echo "å®‰å…¨æ‰«æå®Œæˆ"
          
          # å•å…ƒæµ‹è¯•
          - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          - python3 -m pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-report=term
          
          # æ•°æ®åº“è¿ç§»æµ‹è¯•
          - echo "ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“è¿ç§»..."
          - mkdir -p test_data
          - DB_URL=sqlite:///test_data/test.db alembic upgrade head
          - DB_URL=sqlite:///test_data/test.db alembic current
          
          # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
          - echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
          - ls -la coverage.xml || echo "æ— è¦†ç›–ç‡æŠ¥å‘Š"
          - ls -la bandit-report.json || echo "æ— å®‰å…¨æŠ¥å‘Š"

  # é˜¶æ®µ 2: æ„å»ºå’Œæ¨é€é•œåƒ
  - stage:
    name: build_and_push
    displayName: æ„å»ºä¸æ¨é€é•œåƒ
    dependsOn: quality_and_test
    steps:
      - step: build@python
        name: docker_build_push
        displayName: Docker æ„å»ºã€æµ‹è¯•ä¸æ¨é€
        pythonVersion: '3.11'
        commands:
          # è®¾ç½®å˜é‡
          - |
            VERSION=$(git rev-parse --short HEAD)
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            IMAGE_FULL="${REGISTRY}/${IMAGE_NAME}"
            echo "æ„å»ºç‰ˆæœ¬: ${VERSION}, æ—¶é—´æˆ³: ${TIMESTAMP}"
            
          # Docker ç™»å½•
          - echo "ğŸ”‘ ç™»å½•é•œåƒä»“åº“..."
          - echo "${REGISTRY_PASSWORD}" | docker login "${REGISTRY}" -u "${REGISTRY_USERNAME}" --password-stdin
          
          # å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
          - echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
          - |
            docker build \
              --build-arg VERSION=${VERSION} \
              --build-arg BUILD_TIME=${TIMESTAMP} \
              --cache-from "${IMAGE_FULL}:latest" \
              -f Dockerfile \
              -t "${IMAGE_FULL}:${VERSION}" \
              -t "${IMAGE_FULL}:latest" \
              -t "${IMAGE_FULL}:${TIMESTAMP}" \
              .
            
          # å®¹å™¨å®‰å…¨æ‰«æ
          - echo "ğŸ›¡ï¸ å®¹å™¨å®‰å…¨æ‰«æ..."
          - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --exit-code 0 --severity HIGH,CRITICAL "${IMAGE_FULL}:${VERSION}" || echo "å®‰å…¨æ‰«æå®Œæˆ"
          
          # å†’çƒŸæµ‹è¯•
          - echo "ğŸ’¨ è¿è¡Œå†’çƒŸæµ‹è¯•..."
          - |
            # å¯åŠ¨æµ‹è¯•å®¹å™¨
            docker run -d --name ci-app -p 8000:8000 \
              -e APP_PORT=8000 \
              -e LOG_LEVEL=INFO \
              -e GITEE_WEBHOOK_SECRET=ci-secret \
              -e DB_URL=sqlite:///data/sync.db \
              -e ENVIRONMENT=ci \
              "${IMAGE_FULL}:${VERSION}"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            for i in {1..30}; do
              if curl -f http://127.0.0.1:8000/health >/dev/null 2>&1; then
                echo "æœåŠ¡å¯åŠ¨æˆåŠŸ"
                break
              fi
              sleep 1
            done
            
            # å¥åº·æ£€æŸ¥æµ‹è¯•
            echo "ğŸ¥ å¥åº·æ£€æŸ¥æµ‹è¯•..."
            health_response=$(curl -s http://127.0.0.1:8000/health)
            echo "å¥åº·æ£€æŸ¥å“åº”: $health_response"
            
            # æŒ‡æ ‡ç«¯ç‚¹æµ‹è¯•
            echo "ğŸ“Š æŒ‡æ ‡ç«¯ç‚¹æµ‹è¯•..."
            metrics_code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/metrics)
            if [ "$metrics_code" != "200" ]; then 
              echo "æŒ‡æ ‡ç«¯ç‚¹æµ‹è¯•å¤±è´¥: $metrics_code"
              docker logs ci-app
              exit 1
            fi
            
            # API æ–‡æ¡£æµ‹è¯•
            echo "ğŸ“š API æ–‡æ¡£æµ‹è¯•..."
            docs_code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/docs)
            if [ "$docs_code" != "200" ]; then 
              echo "API æ–‡æ¡£æµ‹è¯•å¤±è´¥: $docs_code"
              docker logs ci-app
              exit 1
            fi
            
            # Webhook åŠŸèƒ½æµ‹è¯•
            echo "ğŸ”— Webhook åŠŸèƒ½æµ‹è¯•..."
            BODY='{"issue":{"id":9001,"number":9001,"title":"ci-test"}}'
            SIG=$(python3 - <<'PY'
import hmac,hashlib
sec=b"ci-secret"; body=b'{"issue":{"id":9001,"number":9001,"title":"ci-test"}}'
print(hmac.new(sec, body, hashlib.sha256).hexdigest())
PY
            )
            webhook_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "X-Gitee-Token: $SIG" \
              -H "X-Gitee-Event: Issue Hook" \
              -H "Content-Type: application/json" \
              -d "$BODY" \
              http://127.0.0.1:8000/gitee_webhook)
            
            echo "Webhook æµ‹è¯•å“åº”ç : $webhook_code"
            
            # è¾“å‡ºæ—¥å¿—å¹¶æ¸…ç†
            echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
            docker logs --tail 50 ci-app
            docker rm -f ci-app

          # Alembic è¿ç§»éªŒè¯
          - echo "ğŸ”„ éªŒè¯æ•°æ®åº“è¿ç§»..."
          - |
            docker run --rm --name ci-alembic \
              -e DB_URL=sqlite:///data/sync.db \
              -v $(pwd):/app \
              -w /app \
              "${IMAGE_FULL}:${VERSION}" \
              sh -c "alembic current && echo 'Alembic çŠ¶æ€éªŒè¯æˆåŠŸ'"

          # æ¨é€é•œåƒ
          - echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
          - |
            VERSION=$(git rev-parse --short HEAD)
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            IMAGE_FULL="${REGISTRY}/${IMAGE_NAME}"
            
            docker push "${IMAGE_FULL}:${VERSION}"
            docker push "${IMAGE_FULL}:latest" 
            docker push "${IMAGE_FULL}:${TIMESTAMP}"
            
            echo "âœ… é•œåƒæ¨é€å®Œæˆ:"
            echo "  - ${IMAGE_FULL}:${VERSION}"
            echo "  - ${IMAGE_FULL}:latest"
            echo "  - ${IMAGE_FULL}:${TIMESTAMP}"

  # é˜¶æ®µ 3: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  - stage:
    name: deploy_staging
    displayName: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    dependsOn: build_and_push
    condition: eq('${{ parameters.deploy_staging }}', 'true')
    steps:
      - step: build@python
        name: staging_deploy
        displayName: é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
        pythonVersion: '3.11'
        commands:
          - echo "ğŸš€ éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ..."
          - |
            VERSION=$(git rev-parse --short HEAD)
            echo "éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
            
            # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„éƒ¨ç½²è„šæœ¬
            # ä¾‹å¦‚: kubectl, docker-compose, ansible ç­‰
            echo "TODO: æ·»åŠ å…·ä½“çš„é¢„å‘å¸ƒéƒ¨ç½²é€»è¾‘"

  # é˜¶æ®µ 4: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  - stage:
    name: deploy_production
    displayName: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    dependsOn: deploy_staging
    condition: and(eq('${{ parameters.deploy_production }}', 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    steps:
      - step: build@python
        name: production_deploy
        displayName: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
        pythonVersion: '3.11'
        commands:
          - echo "ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          - |
            VERSION=$(git rev-parse --short HEAD)
            echo "ç”Ÿäº§éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
            
            # ç”Ÿäº§éƒ¨ç½²å‰çš„æœ€ç»ˆæ£€æŸ¥
            echo "ğŸ” ç”Ÿäº§éƒ¨ç½²å‰æ£€æŸ¥..."
            
            # è¿™é‡Œæ·»åŠ ç”Ÿäº§éƒ¨ç½²è„šæœ¬
            echo "TODO: æ·»åŠ å…·ä½“çš„ç”Ÿäº§éƒ¨ç½²é€»è¾‘"
            
            echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ"

# æµæ°´çº¿å‚æ•°
parameters:
  - name: deploy_staging
    displayName: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    type: boolean
    default: false
    
  - name: deploy_production
    displayName: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    type: boolean
    default: false

# è§¦å‘æ¡ä»¶
triggers:
  push:
    branches:
      include:
        - main
        - develop
  pull_request:
    branches:
      include:
        - main 