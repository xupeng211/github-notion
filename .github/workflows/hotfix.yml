name: ðŸ”§ Emergency Hotfix Deployment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - 'deploy'
        - 'restart'
        - 'status'

env:
  AWS_SERVER: "3.35.106.116"
  APP_DIR: "/opt/github-notion-sync"

jobs:
  hotfix:
    name: ðŸš¨ Emergency Fix
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem
        ssh-keyscan -H ${{ env.AWS_SERVER }} >> ~/.ssh/known_hosts

    - name: ðŸš¨ Execute Emergency Fix
      run: |
        cat > emergency_fix.sh << 'EOF'
        #!/bin/bash
        set -euo pipefail

        echo "ðŸš¨ æ‰§è¡Œç´§æ€¥ä¿®å¤..."

        APP_DIR="/opt/github-notion-sync"
        SERVICE_NAME="github-notion-sync"

        # æ£€æŸ¥å½“å‰çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥å½“å‰çŠ¶æ€..."
        sudo systemctl status $SERVICE_NAME --no-pager || echo "æœåŠ¡æœªè¿è¡Œ"

        # åœæ­¢æœåŠ¡
        echo "â¹ï¸  åœæ­¢æœåŠ¡..."
        sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
        sudo pkill -f "uvicorn" 2>/dev/null || true

        # æ£€æŸ¥ç«¯å£
        echo "ðŸ” æ£€æŸ¥ç«¯å£å ç”¨..."
        sudo netstat -tlnp | grep :8000 || echo "ç«¯å£ 8000 ç©ºé—²"

        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p $APP_DIR
        sudo chown ubuntu:ubuntu $APP_DIR
        cd $APP_DIR

        # æ£€æŸ¥ Python çŽ¯å¢ƒ
        echo "ðŸ æ£€æŸ¥ Python çŽ¯å¢ƒ..."
        python3 --version
        which python3

        # æ£€æŸ¥ pip
        python3 -m pip --version || {
            echo "ðŸ“¦ å®‰è£… pip..."
            curl https://bootstrap.pypa.io/get-pip.py | python3 --user
        }

        # å®‰è£…æ ¸å¿ƒä¾èµ–
        echo "ðŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–..."
        python3 -m pip install --user --upgrade pip
        python3 -m pip install --user fastapi==0.111.0 uvicorn==0.30.1

        # åˆ›å»ºæœ€å°æµ‹è¯•åº”ç”¨
        echo "ðŸ”§ åˆ›å»ºæµ‹è¯•åº”ç”¨..."
        cat > test_app.py << 'PYEOF'
from fastapi import FastAPI
from datetime import datetime

app = FastAPI(title="GitHub-Notion Sync Emergency")

@app.get("/health")
def health():
    return {
        "status": "ok",
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "environment": "production",
        "message": "Emergency service running"
    }

@app.get("/")
def root():
    return {"message": "GitHub-Notion Sync - Emergency Mode", "status": "ok"}
PYEOF

        # åˆ›å»ºç®€åŒ–çš„ systemd æœåŠ¡
        echo "ðŸ”§ åˆ›å»ºæµ‹è¯•æœåŠ¡..."
        sudo tee /etc/systemd/system/emergency-service.service > /dev/null << 'SERVICEEOF'
[Unit]
Description=Emergency GitHub-Notion Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/github-notion-sync
Environment=PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin
ExecStart=/home/ubuntu/.local/bin/uvicorn test_app:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SERVICEEOF

        # å¯åŠ¨ç´§æ€¥æœåŠ¡
        echo "ðŸš€ å¯åŠ¨ç´§æ€¥æœåŠ¡..."
        sudo systemctl daemon-reload
        sudo systemctl enable emergency-service
        sudo systemctl start emergency-service

        # ç­‰å¾…å¯åŠ¨
        sleep 15

        # æ£€æŸ¥çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        sudo systemctl status emergency-service --no-pager

        # æ£€æŸ¥è¿›ç¨‹
        echo "ðŸ” æ£€æŸ¥è¿›ç¨‹..."
        ps aux | grep uvicorn | grep -v grep || echo "è¿›ç¨‹æœªæ‰¾åˆ°"

        # æ£€æŸ¥ç«¯å£
        echo "ðŸ” æ£€æŸ¥ç«¯å£..."
        sudo netstat -tlnp | grep :8000 || echo "ç«¯å£æœªç›‘å¬"

        # æµ‹è¯•è¿žæŽ¥
        echo "ðŸ§ª æµ‹è¯•è¿žæŽ¥..."
        for i in {1..5}; do
            if curl -f http://localhost:8000/health; then
                echo "âœ… è¿žæŽ¥æˆåŠŸ"
                break
            else
                echo "âŒ è¿žæŽ¥å¤±è´¥ï¼Œé‡è¯• $i/5"
                sleep 5
            fi
        done

        echo "âœ… ç´§æ€¥ä¿®å¤å®Œæˆ"
        EOF

        # æ‰§è¡Œä¿®å¤
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no emergency_fix.sh ubuntu@${{ env.AWS_SERVER }}:/tmp/
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "chmod +x /tmp/emergency_fix.sh && /tmp/emergency_fix.sh"

    - name: ðŸ§ª Verify Fix
      run: |
        echo "ðŸ” éªŒè¯ä¿®å¤ç»“æžœ..."
        sleep 15

        if curl -f http://${{ env.AWS_SERVER }}:8000/health; then
          echo "âœ… ç´§æ€¥ä¿®å¤æˆåŠŸï¼"
        else
          echo "âŒ ä¿®å¤å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è¯Šæ–­"

          # èŽ·å–æ›´å¤šè¯Šæ–­ä¿¡æ¯
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "
            echo '=== ç³»ç»ŸçŠ¶æ€ ==='
            sudo systemctl status emergency-service --no-pager || true
            echo '=== ç«¯å£çŠ¶æ€ ==='
            sudo netstat -tlnp | grep :8000 || echo 'ç«¯å£ 8000 æœªç›‘å¬'
            echo '=== è¿›ç¨‹çŠ¶æ€ ==='
            ps aux | grep uvicorn || echo 'æ²¡æœ‰ uvicorn è¿›ç¨‹'
            echo '=== æœ€æ–°æ—¥å¿— ==='
            sudo journalctl -u emergency-service --no-pager -n 30 || true
            echo '=== Python çŽ¯å¢ƒ ==='
            python3 --version
            /home/ubuntu/.local/bin/uvicorn --version || echo 'uvicorn æœªå®‰è£…'
          "
        fi
