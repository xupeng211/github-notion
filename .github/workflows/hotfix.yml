name: ðŸ”§ Emergency Hotfix Deployment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - 'deploy'
        - 'restart'
        - 'status'

env:
  AWS_SERVER: "3.35.106.116"
  APP_DIR: "/opt/github-notion-sync"

jobs:
  hotfix:
    name: ðŸš¨ Emergency Fix
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem
        ssh-keyscan -H ${{ env.AWS_SERVER }} >> ~/.ssh/known_hosts
        
    - name: ðŸš¨ Execute Emergency Fix
      run: |
        cat > emergency_fix.sh << 'EOF'
        #!/bin/bash
        set -euo pipefail
        
        echo "ðŸš¨ æ‰§è¡Œç´§æ€¥ä¿®å¤..."
        
        APP_DIR="/opt/github-notion-sync"
        SERVICE_NAME="github-notion-sync"
        
        # æ£€æŸ¥å½“å‰çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥å½“å‰çŠ¶æ€..."
        sudo systemctl status $SERVICE_NAME --no-pager || echo "æœåŠ¡æœªè¿è¡Œ"
        
        # åœæ­¢æœåŠ¡
        echo "â¹ï¸  åœæ­¢æœåŠ¡..."
        sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
        sudo pkill -f "uvicorn" 2>/dev/null || true
        
        # æ£€æŸ¥ç«¯å£
        echo "ðŸ” æ£€æŸ¥ç«¯å£å ç”¨..."
        sudo netstat -tlnp | grep :8000 || echo "ç«¯å£ 8000 ç©ºé—²"
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p $APP_DIR
        sudo chown ubuntu:ubuntu $APP_DIR
        cd $APP_DIR
        
        # æ£€æŸ¥ Python çŽ¯å¢ƒ
        echo "ðŸ æ£€æŸ¥ Python çŽ¯å¢ƒ..."
        python3 --version
        which python3
        
        # æ£€æŸ¥ pip
        python3 -m pip --version || {
            echo "ðŸ“¦ å®‰è£… pip..."
            curl https://bootstrap.pypa.io/get-pip.py | python3 --user
        }
        
        # å®‰è£…æ ¸å¿ƒä¾èµ–
        echo "ðŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–..."
        python3 -m pip install --user --upgrade pip
        python3 -m pip install --user fastapi uvicorn
        
        # åˆ›å»ºæœ€å°æµ‹è¯•åº”ç”¨
        echo "ðŸ”§ åˆ›å»ºæµ‹è¯•åº”ç”¨..."
        cat > test_app.py << PYEOF
        from fastapi import FastAPI
        import json
        from datetime import datetime
        
        app = FastAPI(title="GitHub-Notion Sync Test")
        
        @app.get("/health")
        async def health():
            return {
                "status": "ok",
                "timestamp": datetime.utcnow().isoformat() + "Z",
                "environment": "production",
                "message": "Emergency test service running"
            }
        
        @app.get("/")
        async def root():
            return {"message": "GitHub-Notion Sync Service - Emergency Mode"}
        PYEOF
        
        # åˆ›å»ºç®€åŒ–çš„ systemd æœåŠ¡
        echo "ðŸ”§ åˆ›å»ºæµ‹è¯•æœåŠ¡..."
        sudo tee /etc/systemd/system/test-service.service > /dev/null << SERVICEEOF
        [Unit]
        Description=Test Service
        After=network.target
        
        [Service]
        Type=simple
        User=ubuntu
        WorkingDirectory=$APP_DIR
        Environment=PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin
        ExecStart=/home/ubuntu/.local/bin/uvicorn test_app:app --host 0.0.0.0 --port 8000
        Restart=always
        RestartSec=5
        
        [Install]
        WantedBy=multi-user.target
        SERVICEEOF
        
        # å¯åŠ¨æµ‹è¯•æœåŠ¡
        echo "ðŸš€ å¯åŠ¨æµ‹è¯•æœåŠ¡..."
        sudo systemctl daemon-reload
        sudo systemctl enable test-service
        sudo systemctl start test-service
        
        # ç­‰å¾…å¯åŠ¨
        sleep 10
        
        # æ£€æŸ¥çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥æµ‹è¯•æœåŠ¡çŠ¶æ€..."
        sudo systemctl status test-service --no-pager
        
        # æµ‹è¯•è¿žæŽ¥
        echo "ðŸ§ª æµ‹è¯•è¿žæŽ¥..."
        curl -f http://localhost:8000/health || echo "æµ‹è¯•å¤±è´¥"
        
        echo "âœ… ç´§æ€¥ä¿®å¤å®Œæˆ"
        EOF
        
        # æ‰§è¡Œä¿®å¤
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no emergency_fix.sh ubuntu@${{ env.AWS_SERVER }}:/tmp/
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "chmod +x /tmp/emergency_fix.sh && /tmp/emergency_fix.sh"
        
    - name: ðŸ§ª Verify Fix
      run: |
        echo "ðŸ” éªŒè¯ä¿®å¤ç»“æžœ..."
        sleep 15
        
        if curl -f http://${{ env.AWS_SERVER }}:8000/health; then
          echo "âœ… ç´§æ€¥ä¿®å¤æˆåŠŸï¼"
        else
          echo "âŒ ä¿®å¤å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è¯Šæ–­"
          
          # èŽ·å–æ›´å¤šè¯Šæ–­ä¿¡æ¯
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "
            echo '=== ç³»ç»ŸçŠ¶æ€ ==='
            sudo systemctl status test-service --no-pager || true
            echo '=== ç«¯å£çŠ¶æ€ ==='
            sudo netstat -tlnp | grep :8000 || echo 'ç«¯å£ 8000 æœªç›‘å¬'
            echo '=== è¿›ç¨‹çŠ¶æ€ ==='
            ps aux | grep uvicorn || echo 'æ²¡æœ‰ uvicorn è¿›ç¨‹'
            echo '=== æ—¥å¿— ==='
            sudo journalctl -u test-service --no-pager -n 20 || true
          "
        fi
