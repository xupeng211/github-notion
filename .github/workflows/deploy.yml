name: ðŸš€ Simple Direct Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_SERVER: "3.35.106.116"
  APP_DIR: "/opt/github-notion-sync"

jobs:
  deploy:
    name: ðŸš€ Direct Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem
        ssh-keyscan -H ${{ env.AWS_SERVER }} >> ~/.ssh/known_hosts
        
    - name: ðŸš€ Deploy to AWS EC2
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        set -euo pipefail
        
        echo "ðŸš€ å¼€å§‹éƒ¨ç½² GitHub-Notion åŒæ­¥ç³»ç»Ÿ..."
        
        # è®¾ç½®å˜é‡
        APP_DIR="/opt/github-notion-sync"
        SERVICE_NAME="github-notion-sync"
        
        # åœæ­¢çŽ°æœ‰æœåŠ¡
        echo "â¹ï¸  åœæ­¢çŽ°æœ‰æœåŠ¡..."
        sudo systemctl stop $SERVICE_NAME || true
        sudo pkill -f "uvicorn app.server:app" || true
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        echo "ðŸ“ å‡†å¤‡åº”ç”¨ç›®å½•..."
        sudo mkdir -p $APP_DIR
        sudo chown ubuntu:ubuntu $APP_DIR
        cd $APP_DIR
        
        # æ¸…ç†æ—§æ–‡ä»¶
        rm -rf .git app tests docs tools *.py *.txt *.yml *.yaml *.md || true
        
        # ç­‰å¾…æ–‡ä»¶ä¼ è¾“å®Œæˆ
        echo "â³ ç­‰å¾…æ–‡ä»¶ä¼ è¾“..."
        sleep 5
        
        # æ£€æŸ¥ Python å’Œ pip
        echo "ðŸ æ£€æŸ¥ Python çŽ¯å¢ƒ..."
        python3 --version
        pip3 --version || (curl https://bootstrap.pypa.io/get-pip.py | python3)
        
        # å®‰è£…ä¾èµ–
        echo "ðŸ“¦ å®‰è£… Python ä¾èµ–..."
        pip3 install --user fastapi uvicorn[standard] sqlalchemy httpx requests python-dotenv pydantic email-validator starlette typing-extensions prometheus-client python-json-logger cryptography pyopenssl boto3 apscheduler pyyaml alembic
        
        # åˆ›å»ºçŽ¯å¢ƒé…ç½®
        echo "âš™ï¸  åˆ›å»ºçŽ¯å¢ƒé…ç½®..."
        cat > .env << ENVEOF
        ENVIRONMENT=production
        DB_URL=sqlite:///./data/app.db
        GITHUB_WEBHOOK_SECRET=$GITHUB_WEBHOOK_SECRET
        NOTION_TOKEN=$NOTION_TOKEN
        NOTION_DATABASE_ID=$NOTION_DATABASE_ID
        GITHUB_TOKEN=$GITHUB_TOKEN
        DEADLETTER_REPLAY_TOKEN=$DEADLETTER_REPLAY_TOKEN
        RATE_LIMIT_PER_MINUTE=100
        MAX_REQUEST_SIZE=2097152
        DISABLE_NOTION=false
        LOG_LEVEL=INFO
        ENVEOF
        
        # åˆ›å»ºæ•°æ®ç›®å½•
        mkdir -p data logs
        
        # åˆå§‹åŒ–æ•°æ®åº“
        echo "ðŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
        python3 -c "
        import sys
        sys.path.insert(0, '.')
        from app.models import init_db
        init_db()
        print('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')
        " || echo "âš ï¸  æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²"
        
        # åˆ›å»º systemd æœåŠ¡
        echo "ðŸ”§ åˆ›å»ºç³»ç»ŸæœåŠ¡..."
        sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null << SERVICEEOF
        [Unit]
        Description=GitHub-Notion Sync Service
        After=network.target
        
        [Service]
        Type=simple
        User=ubuntu
        WorkingDirectory=$APP_DIR
        Environment=PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin
        ExecStart=/home/ubuntu/.local/bin/uvicorn app.server:app --host 0.0.0.0 --port 8000
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
        SERVICEEOF
        
        # é‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨æœåŠ¡
        echo "ðŸ”„ å¯åŠ¨æœåŠ¡..."
        sudo systemctl daemon-reload
        sudo systemctl enable $SERVICE_NAME
        sudo systemctl start $SERVICE_NAME
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "ðŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        sudo systemctl status $SERVICE_NAME --no-pager || true
        
        # æµ‹è¯•å¥åº·æ£€æŸ¥
        echo "ðŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥..."
        curl -f http://localhost:8000/health || echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥"
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ðŸŒ æœåŠ¡åœ°å€: http://$AWS_SERVER:8000"
        echo "ðŸ¥ å¥åº·æ£€æŸ¥: http://$AWS_SERVER:8000/health"
        EOF
        
        # ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨
        echo "ðŸ“¤ ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no -r . ubuntu@${{ env.AWS_SERVER }}:${{ env.APP_DIR }}/
        
        # ä¼ è¾“éƒ¨ç½²è„šæœ¬
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no deploy_script.sh ubuntu@${{ env.AWS_SERVER }}:/tmp/
        
        # æ‰§è¡Œéƒ¨ç½²
        echo "ðŸš€ æ‰§è¡Œè¿œç¨‹éƒ¨ç½²..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} \
          "GITHUB_WEBHOOK_SECRET='${{ secrets.GITHUB_WEBHOOK_SECRET }}' \
           NOTION_TOKEN='${{ secrets.NOTION_TOKEN }}' \
           NOTION_DATABASE_ID='${{ secrets.NOTION_DATABASE_ID }}' \
           GITHUB_TOKEN='${{ secrets.GITHUB_TOKEN }}' \
           DEADLETTER_REPLAY_TOKEN='${{ secrets.DEADLETTER_REPLAY_TOKEN }}' \
           bash /tmp/deploy_script.sh"
           
    - name: ðŸ§ª Verify deployment
      run: |
        echo "ðŸ” éªŒè¯éƒ¨ç½²..."
        sleep 30
        
        # æµ‹è¯•å¥åº·æ£€æŸ¥
        if curl -f http://${{ env.AWS_SERVER }}:8000/health; then
          echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸï¼"
        else
          echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥"
          exit 1
        fi
        
    - name: ðŸ“Š Deployment summary
      if: always()
      run: |
        echo "ðŸ“Š éƒ¨ç½²æ€»ç»“:"
        echo "ðŸŽ¯ ç›®æ ‡æœåŠ¡å™¨: ${{ env.AWS_SERVER }}"
        echo "ðŸ“ åº”ç”¨ç›®å½•: ${{ env.APP_DIR }}"
        echo "ðŸŒ æœåŠ¡åœ°å€: http://${{ env.AWS_SERVER }}:8000"
        echo "ðŸ¥ å¥åº·æ£€æŸ¥: http://${{ env.AWS_SERVER }}:8000/health"
        echo "ðŸ“Š ç›‘æŽ§æŒ‡æ ‡: http://${{ env.AWS_SERVER }}:8000/metrics"
