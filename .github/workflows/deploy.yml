name: ğŸš€ CI/CD Pipeline - Build & Deploy

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_to_aws:
        description: 'Deploy to AWS server'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: xupeng211/gitee-notion

jobs:
  # é˜¶æ®µ 1: æµ‹è¯•å’Œè´¨é‡æ£€æŸ¥
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov bandit flake8

    - name: ğŸ” Code quality checks
      run: |
        echo "ğŸ“ Running code style checks..."
        flake8 app/ --max-line-length=120 --ignore=E203,W503 || echo "Style check completed"
        
        echo "ğŸ”’ Running security scan..."
        bandit -r app/ -f json -o bandit-report.json || echo "Security scan completed"

    - name: ğŸ§ª Run tests
      run: |
        python -m pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-report=term

    - name: ğŸ—„ï¸ Test database migrations
      run: |
        mkdir -p test_data
        DB_URL=sqlite:///test_data/test.db alembic upgrade head
        DB_URL=sqlite:///test_data/test.db alembic current

  # é˜¶æ®µ 2: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.optimized
        target: production
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ github.sha }}
          BUILD_TIME=${{ github.run_number }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: ğŸ“Š Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  # é˜¶æ®µ 3: éƒ¨ç½²åˆ° AWS æœåŠ¡å™¨
  deploy-aws:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event.inputs.deploy_to_aws == 'true')
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“‹ Prepare deployment files
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp docker-compose.production.yml deploy/
        cp -r monitoring deploy/ 2>/dev/null || echo "No monitoring config"
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        cat > deploy/.env << EOF
        # ç”Ÿäº§ç¯å¢ƒé…ç½®
        LOG_LEVEL=INFO
        ENVIRONMENT=production
        APP_PORT=8000
        
        # æ•°æ®åº“é…ç½®
        DB_URL=sqlite:///data/sync.db
        
        # é•œåƒé…ç½®
        REGISTRY=${{ env.REGISTRY }}
        IMAGE_NAME=${{ env.IMAGE_NAME }}
        IMAGE_TAG=latest
        
        # æœåŠ¡é…ç½®
        SERVICE_PORT=8000
        SERVICE_ENV=production
        DEPLOYMENT_TIME=$(date +%Y%m%d-%H%M%S)
        
        # å®‰å…¨é…ç½®
        RATE_LIMIT_PER_MINUTE=60
        MAX_REQUEST_SIZE=1048576
        DEADLETTER_REPLAY_TOKEN=${{ secrets.DEADLETTER_REPLAY_TOKEN }}
        
        # ç›‘æ§é…ç½®
        GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
        GRAFANA_SECRET_KEY=${{ secrets.GRAFANA_SECRET_KEY }}
        
        # Gitee é…ç½®
        GITEE_WEBHOOK_SECRET=${{ secrets.GITEE_WEBHOOK_SECRET }}
        
        # Notion é…ç½®
        NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}
        EOF
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy/deploy.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹ AWS æœåŠ¡å™¨éƒ¨ç½²..."
        
        # å®‰è£… Docker (å¦‚æœæœªå®‰è£…)
        if ! command -v docker >/dev/null 2>&1; then
            echo "ğŸ“¦ å®‰è£… Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            rm get-docker.sh
        fi
        
        # å®‰è£… Docker Compose (å¦‚æœæœªå®‰è£…)
        if ! command -v docker-compose >/dev/null 2>&1; then
            echo "ğŸ“¦ å®‰è£… Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        APP_DIR="/opt/gitee-notion-sync"
        sudo mkdir -p "$APP_DIR"
        sudo chown $USER:$USER "$APP_DIR"
        
        # å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç›®å½•
        cp -r . "$APP_DIR/"
        cd "$APP_DIR"
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        source .env
        
        # ç™»å½• GitHub Container Registry
        echo "ğŸ”‘ ç™»å½•å®¹å™¨æ³¨å†Œè¡¨..."
        echo "$GITHUB_TOKEN" | docker login ghcr.io -u xupeng211 --password-stdin
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p data logs
        
        # åœæ­¢æ—§æœåŠ¡
        echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
        docker-compose -f docker-compose.production.yml down 2>/dev/null || true
        
        # æ‹‰å–æœ€æ–°é•œåƒ
        echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
        docker pull "${REGISTRY}/${IMAGE_NAME}:latest"
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        docker-compose -f docker-compose.production.yml up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 15
        
        # å¥åº·æ£€æŸ¥
        for i in {1..30}; do
            if curl -f http://localhost:8000/health >/dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ!"
                break
            fi
            if [[ $i -eq 30 ]]; then
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
                docker-compose logs
                exit 1
            fi
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
        done
        
        # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
        docker-compose ps
        
        echo ""
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ğŸ“ æœåŠ¡è®¿é—®åœ°å€:"
        echo "  å¥åº·æ£€æŸ¥: http://$(curl -s ifconfig.me):8000/health"
        echo "  API æ–‡æ¡£:  http://$(curl -s ifconfig.me):8000/docs"
        echo "  ç›‘æ§æŒ‡æ ‡: http://$(curl -s ifconfig.me):8000/metrics"
        SCRIPT_EOF
        
        chmod +x deploy/deploy.sh

    - name: ğŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem
        ssh-keyscan -H 13.209.76.79 >> ~/.ssh/known_hosts

    - name: ğŸ“¤ Upload to AWS server
      run: |
        scp -i ~/.ssh/aws-key.pem -r deploy ubuntu@13.209.76.79:/tmp/gitee-notion-deploy-$(date +%Y%m%d-%H%M%S)

    - name: ğŸš€ Deploy on AWS server
      run: |
        ssh -i ~/.ssh/aws-key.pem ubuntu@13.209.76.79 "
          cd /tmp/gitee-notion-deploy-* &&
          GITHUB_TOKEN='${{ secrets.GITHUB_TOKEN }}' bash deploy.sh
        "

    - name: ğŸ” Verify deployment
      run: |
        sleep 10
        curl -f http://13.209.76.79:8000/health || (echo "Health check failed" && exit 1)
        echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ!"

  # é˜¶æ®µ 4: é€šçŸ¥ (å¯é€‰)
  notify:
    needs: [build-and-push, deploy-aws]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [[ "${{ needs.deploy-aws.result }}" == "success" ]]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "ğŸŒ æœåŠ¡åœ°å€: http://13.209.76.79:8000"
          echo "ğŸ“š API æ–‡æ¡£: http://13.209.76.79:8000/docs"
          echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://13.209.76.79:8000/health"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi 