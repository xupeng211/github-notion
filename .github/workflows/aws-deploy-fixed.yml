name: ğŸš€ AWS Deployment Fixed

on:
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: 'Deployment mode'
        required: true
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'minimal'

env:
  AWS_SERVER: "3.35.106.116"
  APP_DIR: "/opt/github-notion-sync"
  SERVICE_NAME: "github-notion-sync"

jobs:
  deploy:
    name: ğŸš€ Deploy to AWS EC2
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem
        ssh-keyscan -H ${{ env.AWS_SERVER }} >> ~/.ssh/known_hosts
        
        # æµ‹è¯• SSH è¿æ¥
        echo "ğŸ” æµ‹è¯• SSH è¿æ¥..."
        ssh -i ~/.ssh/aws-key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "echo 'SSH è¿æ¥æˆåŠŸ'"
        
    - name: ğŸ§¹ Cleanup server
      run: |
        echo "ğŸ§¹ æ¸…ç†æœåŠ¡å™¨ç¯å¢ƒ..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        sudo systemctl stop github-notion-sync 2>/dev/null || true
        sudo systemctl stop emergency-service 2>/dev/null || true
        sudo pkill -f "uvicorn" 2>/dev/null || true
        sudo fuser -k 8000/tcp 2>/dev/null || true
        sudo mkdir -p /opt/github-notion-sync
        sudo chown ubuntu:ubuntu /opt/github-notion-sync
        cd /opt/github-notion-sync
        rm -rf app/ *.py *.txt *.log 2>/dev/null || true
        echo "âœ… æœåŠ¡å™¨æ¸…ç†å®Œæˆ"
        '
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        python3 --version
        python3 -m pip install --user --upgrade pip
        
        if [ "${{ github.event.inputs.deployment_mode }}" = "minimal" ]; then
          echo "æœ€å°åŒ–å®‰è£…..."
          python3 -m pip install --user fastapi==0.111.0 uvicorn==0.30.1 pydantic==1.10.22 sqlalchemy==2.0.30 python-dotenv==1.0.1 httpx==0.27.0
        else
          echo "å®Œæ•´å®‰è£…..."
          python3 -m pip install --user fastapi==0.111.0 uvicorn[standard]==0.30.1
          python3 -m pip install --user pydantic==1.10.22 sqlalchemy==2.0.30 python-dotenv==1.0.1
          python3 -m pip install --user httpx==0.27.0 requests==2.31.0 cryptography==42.0.5
          python3 -m pip install --user prometheus-client==0.20.0 python-json-logger==2.0.7
        fi
        
        python3 -c "import fastapi, uvicorn, sqlalchemy; print(\"âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡\")"
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        '
        
    - name: ğŸ“¤ Transfer files
      run: |
        echo "ğŸ“¤ ä¼ è¾“åº”ç”¨æ–‡ä»¶..."
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no -r app/ ubuntu@${{ env.AWS_SERVER }}:/opt/github-notion-sync/
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no requirements.txt ubuntu@${{ env.AWS_SERVER }}:/opt/github-notion-sync/
        echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
        
    - name: âš™ï¸ Configure environment
      run: |
        echo "âš™ï¸ é…ç½®ç¯å¢ƒ..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        cd /opt/github-notion-sync
        
        cat > .env << ENVEOF
        ENVIRONMENT=production
        DB_URL=sqlite:///./data/app.db
        LOG_LEVEL=INFO
        RATE_LIMIT_PER_MINUTE=100
        MAX_REQUEST_SIZE=2097152
        DISABLE_NOTION=false
        GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}
        GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
        NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}
        DEADLETTER_REPLAY_TOKEN=${{ secrets.DEADLETTER_REPLAY_TOKEN }}
        ENVEOF
        
        mkdir -p data logs
        echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"
        '
        
    - name: ğŸ—„ï¸ Initialize database
      run: |
        echo "ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        cd /opt/github-notion-sync
        python3 -c "
import sys
sys.path.insert(0, \".\")
from app.models import init_db
init_db()
print(\"âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ\")
"
        echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
        '
        
    - name: ğŸ”§ Create service
      run: |
        echo "ğŸ”§ åˆ›å»º systemd æœåŠ¡..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        sudo tee /etc/systemd/system/github-notion-sync.service > /dev/null << "SERVICEEOF"
        [Unit]
        Description=GitHub-Notion Sync Service
        After=network.target
        
        [Service]
        Type=simple
        User=ubuntu
        WorkingDirectory=/opt/github-notion-sync
        Environment=PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin
        EnvironmentFile=/opt/github-notion-sync/.env
        ExecStart=/home/ubuntu/.local/bin/uvicorn app.server:app --host 0.0.0.0 --port 8000
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
        SERVICEEOF
        
        sudo systemctl daemon-reload
        sudo systemctl enable github-notion-sync
        echo "âœ… systemd æœåŠ¡åˆ›å»ºå®Œæˆ"
        '
        
    - name: ğŸš€ Start service
      run: |
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
        sudo systemctl start github-notion-sync
        sleep 15
        sudo systemctl status github-notion-sync --no-pager
        ps aux | grep uvicorn | grep -v grep || echo "âš ï¸ æœªæ‰¾åˆ°è¿›ç¨‹"
        sudo netstat -tlnp | grep :8000 || echo "âš ï¸ ç«¯å£æœªç›‘å¬"
        echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
        '
        
    - name: ğŸ§ª Verify deployment
      run: |
        echo "ğŸ§ª éªŒè¯éƒ¨ç½²..."
        sleep 20
        
        for i in {1..5}; do
          if curl -f -s http://${{ env.AWS_SERVER }}:8000/health >/dev/null; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5"
            sleep 10
          fi
        done
        
        echo "ğŸ“Š å¥åº·æ£€æŸ¥è¯¦æƒ…:"
        curl -s http://${{ env.AWS_SERVER }}:8000/health | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print('çŠ¶æ€:', data.get('status', 'unknown'))
    print('ç¯å¢ƒ:', data.get('environment', 'unknown'))
except:
    print('è§£æå“åº”å¤±è´¥')
"
        
    - name: ğŸ“Š Summary
      if: always()
      run: |
        echo "ğŸ“Š éƒ¨ç½²æ€»ç»“:"
        echo "ğŸŒ æœåŠ¡åœ°å€: http://${{ env.AWS_SERVER }}:8000"
        echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://${{ env.AWS_SERVER }}:8000/health"
        echo "ğŸ”— GitHub Webhook: http://${{ env.AWS_SERVER }}:8000/github_webhook"
        
        if curl -f -s http://${{ env.AWS_SERVER }}:8000/health >/dev/null; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè·å–è¯Šæ–­ä¿¡æ¯..."
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} '
          sudo systemctl status github-notion-sync --no-pager || true
          sudo journalctl -u github-notion-sync --no-pager -n 20 || true
          '
        fi
