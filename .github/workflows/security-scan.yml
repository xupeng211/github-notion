name: "Security Scanning"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write

jobs:
  secrets-scan:
    name: "Secrets Detection"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽsecretsæ‰«æ

      - name: "Run Gitleaks Secrets Scan"
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # å¯é€‰ï¼Œä¼ä¸šç‰ˆè®¸å¯è¯

      - name: "Upload Gitleaks Results"
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks-secrets
        continue-on-error: true

  dependency-scan:
    name: "Dependency Vulnerability Scan"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: "Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety pip-audit bandit

      - name: "Python Security Audit (pip-audit)"
        run: |
          pip-audit --desc --format=json --output=pip-audit-report.json
        continue-on-error: true

      - name: "Upload pip-audit Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json

      - name: "Python Security Check (Safety)"
        run: |
          safety check --json --output=safety-report.json
        continue-on-error: true

      - name: "Upload Safety Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety-report.json

      - name: "Source Code Security Analysis (Bandit)"
        run: |
          bandit -r app/ -f json -o bandit-report.json
        continue-on-error: true

      - name: "Upload Bandit Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  container-scan:
    name: "Container Security Scan"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Build Docker Image"
        run: |
          docker build -f Dockerfile -t github-notion:security-scan .

      - name: "Run Trivy Container Scan"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: github-notion:security-scan
          format: sarif
          output: trivy-container-results.sarif

      - name: "Upload Trivy Container Results"
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-container-results.sarif
          category: trivy-container

      - name: "Run Trivy Filesystem Scan"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs-results.sarif

      - name: "Upload Trivy Filesystem Results"
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs-results.sarif
          category: trivy-filesystem

  security-summary:
    name: "Security Scan Summary"
    runs-on: ubuntu-latest
    needs: [secrets-scan, dependency-scan, container-scan]
    if: always()
    steps:
      - name: "Download All Artifacts"
        uses: actions/download-artifact@v4

      - name: "Create Security Summary"
        run: |
          echo "# ðŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Secretsæ‰«æ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "âœ… æœªå‘çŽ°æ•æ„Ÿä¿¡æ¯æ³„éœ²" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å‘çŽ°æ½œåœ¨æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ä¾èµ–æ‰«æ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "âœ… ä¾èµ–åº“å®‰å…¨æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å‘çŽ°ä¾èµ–åº“å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### å®¹å™¨æ‰«æ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.container-scan.result }}" == "success" ]; then
            echo "âœ… å®¹å™¨å®‰å…¨æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å‘çŽ°å®¹å™¨å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "1. å®šæœŸæ›´æ–°ä¾èµ–åº“åˆ°æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "2. ä½¿ç”¨å¼ºéšæœºå¯†ç ï¼Œé¿å…ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "3. å®šæœŸæ£€æŸ¥å®¹å™¨åŸºç¡€é•œåƒçš„å®‰å…¨æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "4. åœ¨ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå®Œæ•´çš„å®‰å…¨å®¡æŸ¥" >> $GITHUB_STEP_SUMMARY
