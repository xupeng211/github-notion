name: ğŸš€ Robust AWS Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: 'Deployment mode'
        required: true
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'minimal'
        - 'debug'

env:
  AWS_SERVER: "3.35.106.116"
  APP_DIR: "/opt/github-notion-sync"
  SERVICE_NAME: "github-notion-sync"

jobs:
  deploy:
    name: ğŸš€ Deploy to AWS EC2
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup SSH with retry
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
        chmod 600 ~/.ssh/aws-key.pem

        # æ·»åŠ  known_hosts å¹¶æµ‹è¯•è¿æ¥
        ssh-keyscan -H ${{ env.AWS_SERVER }} >> ~/.ssh/known_hosts

        # æµ‹è¯• SSH è¿æ¥
        echo "ğŸ” æµ‹è¯• SSH è¿æ¥..."
        for i in {1..3}; do
          if ssh -i ~/.ssh/aws-key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "echo 'SSH è¿æ¥æˆåŠŸ'"; then
            echo "âœ… SSH è¿æ¥æµ‹è¯•é€šè¿‡"
            break
          else
            echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œé‡è¯• $i/3"
            sleep 5
          fi
        done

    - name: ğŸ§¹ Cleanup and prepare server
      run: |
        echo "ğŸ§¹ æ¸…ç†æœåŠ¡å™¨ç¯å¢ƒ..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        echo "â¹ï¸  åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡..."
        sudo systemctl stop github-notion-sync 2>/dev/null || true
        sudo systemctl stop emergency-service 2>/dev/null || true
        sudo systemctl stop test-service 2>/dev/null || true

        echo "ğŸ”ª ç»ˆæ­¢ç›¸å…³è¿›ç¨‹..."
        sudo pkill -f "uvicorn" 2>/dev/null || true
        sudo pkill -f "python.*app" 2>/dev/null || true

        echo "ğŸ”“ é‡Šæ”¾ç«¯å£ 8000..."
        sudo fuser -k 8000/tcp 2>/dev/null || true

        echo "ğŸ“ å‡†å¤‡åº”ç”¨ç›®å½•..."
        sudo mkdir -p ${{ env.APP_DIR }}
        sudo chown ubuntu:ubuntu ${{ env.APP_DIR }}

        echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
        cd ${{ env.APP_DIR }}
        rm -rf app/ tests/ docs/ *.py *.txt *.yml *.yaml *.md *.log 2>/dev/null || true

        echo "âœ… æœåŠ¡å™¨æ¸…ç†å®Œæˆ"
        EOF

    - name: ğŸ“¦ Install dependencies with retry
      run: |
        echo "ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        echo "ğŸ æ£€æŸ¥ Python ç¯å¢ƒ..."
        python3 --version

        echo "ğŸ“¦ å‡çº§ pip..."
        python3 -m pip install --user --upgrade pip --timeout 60 --retries 3

        echo "ğŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆåˆ†æ‰¹å®‰è£…ä»¥æé«˜æˆåŠŸç‡ï¼‰..."

        if [ "${{ github.event.inputs.deployment_mode }}" = "minimal" ]; then
          echo "  æœ€å°åŒ–å®‰è£…æ¨¡å¼..."
          python3 -m pip install --user --timeout 60 --retries 3 \
            fastapi==0.111.0 \
            uvicorn==0.30.1 \
            pydantic==1.10.22 \
            sqlalchemy==2.0.30 \
            python-dotenv==1.0.1 \
            httpx==0.27.0
        else
          # ç¬¬ä¸€æ‰¹ï¼šæ ¸å¿ƒ web æ¡†æ¶
          echo "  å®‰è£… FastAPI å’Œ Uvicorn..."
          python3 -m pip install --user --timeout 60 --retries 3 \
            fastapi==0.111.0 \
            uvicorn[standard]==0.30.1

          # ç¬¬äºŒæ‰¹ï¼šæ•°æ®å¤„ç†
          echo "  å®‰è£…æ•°æ®å¤„ç†åº“..."
          python3 -m pip install --user --timeout 60 --retries 3 \
            pydantic==1.10.22 \
            sqlalchemy==2.0.30 \
            python-dotenv==1.0.1

          # ç¬¬ä¸‰æ‰¹ï¼šHTTP å’ŒåŠ å¯†
          echo "  å®‰è£… HTTP å’ŒåŠ å¯†åº“..."
          python3 -m pip install --user --timeout 60 --retries 3 \
            httpx==0.27.0 \
            requests==2.31.0 \
            cryptography==42.0.5

          # ç¬¬å››æ‰¹ï¼šå…¶ä»–å·¥å…·
          echo "  å®‰è£…å…¶ä»–å·¥å…·..."
          python3 -m pip install --user --timeout 60 --retries 3 \
            prometheus-client==0.20.0 \
            python-json-logger==2.0.7 \
            email-validator==2.2.0 \
            typing-extensions==4.14.1
        fi

        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

        # éªŒè¯å…³é”®ä¾èµ–
        echo "ğŸ” éªŒè¯ä¾èµ–å®‰è£…..."
        python3 -c "import fastapi, uvicorn, sqlalchemy, httpx; print('âœ… æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"
        EOF

    - name: ğŸ“¤ Transfer application files
      run: |
        echo "ğŸ“¤ ä¼ è¾“åº”ç”¨æ–‡ä»¶..."

        # ä¼ è¾“æ ¸å¿ƒåº”ç”¨æ–‡ä»¶
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no -r app/ ubuntu@${{ env.AWS_SERVER }}:${{ env.APP_DIR }}/

        # ä¼ è¾“é…ç½®æ–‡ä»¶
        scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no requirements.txt ubuntu@${{ env.AWS_SERVER }}:${{ env.APP_DIR }}/

        # ä¼ è¾“ alembic æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "alembic" ]; then
          scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no -r alembic/ ubuntu@${{ env.AWS_SERVER }}:${{ env.APP_DIR }}/
        fi

        if [ -f "alembic.ini" ]; then
          scp -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no alembic.ini ubuntu@${{ env.AWS_SERVER }}:${{ env.APP_DIR }}/
        fi

        echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"

    - name: âš™ï¸ Configure environment
      run: |
        echo "âš™ï¸  é…ç½®ç¯å¢ƒ..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        cd ${{ env.APP_DIR }}

        echo "ğŸ“ åˆ›å»ºç¯å¢ƒé…ç½®..."
        cat > .env << ENVEOF
        ENVIRONMENT=production
        DB_URL=sqlite:///./data/app.db
        LOG_LEVEL=INFO
        RATE_LIMIT_PER_MINUTE=100
        MAX_REQUEST_SIZE=2097152
        DISABLE_NOTION=false

        # GitHub é…ç½®
        GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}
        GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

        # Notion é…ç½®
        NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}

        # å…¶ä»–é…ç½®
        DEADLETTER_REPLAY_TOKEN=${{ secrets.DEADLETTER_REPLAY_TOKEN }}
        ENVEOF

        echo "ğŸ“ åˆ›å»ºæ•°æ®ç›®å½•..."
        mkdir -p data logs

        echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"
        EOF

    - name: ğŸ—„ï¸ Initialize database
      run: |
        echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        cd ${{ env.APP_DIR }}

        echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
        python3 << 'PYEOF'
        import sys
        sys.path.insert(0, '.')
        try:
            from app.models import init_db
            init_db()
            print('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')
        except Exception as e:
            print('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', str(e))
            sys.exit(1)
        PYEOF

        echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
        EOF

    - name: ğŸ”§ Create systemd service
      run: |
        echo "ğŸ”§ åˆ›å»º systemd æœåŠ¡..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        echo "ğŸ”§ åˆ›å»º systemd æœåŠ¡æ–‡ä»¶..."
        sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }}.service > /dev/null << 'SERVICEEOF'
        [Unit]
        Description=GitHub-Notion Sync Service
        After=network.target
        Wants=network-online.target

        [Service]
        Type=simple
        User=ubuntu
        Group=ubuntu
        WorkingDirectory=${{ env.APP_DIR }}
        Environment=PATH=/home/ubuntu/.local/bin:/usr/local/bin:/usr/bin:/bin
        EnvironmentFile=${{ env.APP_DIR }}/.env
        ExecStart=/home/ubuntu/.local/bin/uvicorn app.server:app --host 0.0.0.0 --port 8000 --workers 1
        ExecReload=/bin/kill -HUP $MAINPID
        Restart=always
        RestartSec=10
        StartLimitInterval=60
        StartLimitBurst=3
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=github-notion-sync

        # å®‰å…¨è®¾ç½®
        NoNewPrivileges=true
        PrivateTmp=true
        ProtectSystem=strict
        ReadWritePaths=${{ env.APP_DIR }}

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF

        echo "ğŸ”„ é‡æ–°åŠ è½½ systemd..."
        sudo systemctl daemon-reload
        sudo systemctl enable ${{ env.SERVICE_NAME }}

        echo "âœ… systemd æœåŠ¡åˆ›å»ºå®Œæˆ"
        EOF

    - name: ğŸš€ Start service
      run: |
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} << 'EOF'
        set -e

        echo "ğŸš€ å¯åŠ¨ GitHub-Notion åŒæ­¥æœåŠ¡..."
        sudo systemctl start ${{ env.SERVICE_NAME }}

        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 15

        echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager

        echo "ğŸ” æ£€æŸ¥è¿›ç¨‹..."
        ps aux | grep uvicorn | grep -v grep || echo "âš ï¸  æœªæ‰¾åˆ° uvicorn è¿›ç¨‹"

        echo "ğŸ” æ£€æŸ¥ç«¯å£..."
        sudo netstat -tlnp | grep :8000 || echo "âš ï¸  ç«¯å£ 8000 æœªç›‘å¬"

        echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
        EOF

    - name: ğŸ§ª Verify deployment
      run: |
        echo "ğŸ§ª éªŒè¯éƒ¨ç½²..."

        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        sleep 20

        # æµ‹è¯•å¥åº·æ£€æŸ¥
        echo "ğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥..."
        for i in {1..5}; do
          if curl -f -s http://${{ env.AWS_SERVER }}:8000/health >/dev/null; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5"
            sleep 10
          fi
        done

        # è·å–å¥åº·æ£€æŸ¥è¯¦æƒ…
        echo "ğŸ“Š å¥åº·æ£€æŸ¥è¯¦æƒ…:"
        curl -s http://${{ env.AWS_SERVER }}:8000/health | python3 -c "
        import sys, json
        try:
            data = json.load(sys.stdin)
            print(f'çŠ¶æ€: {data.get(\"status\", \"unknown\")}')
            print(f'ç¯å¢ƒ: {data.get(\"environment\", \"unknown\")}')
            print(f'æ—¶é—´æˆ³: {data.get(\"timestamp\", \"unknown\")}')
            if 'checks' in data:
                for check_name, check_data in data['checks'].items():
                    print(f'{check_name}: {check_data.get(\"status\", \"unknown\")}')
        except Exception as e:
            print(f'è§£æå“åº”å¤±è´¥: {e}')
        "

    - name: ğŸ“Š Deployment summary
      if: always()
      run: |
        echo "ğŸ“Š éƒ¨ç½²æ€»ç»“:"
        echo "ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${{ env.AWS_SERVER }}"
        echo "ğŸ“ åº”ç”¨ç›®å½•: ${{ env.APP_DIR }}"
        echo "ğŸ”§ æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}"
        echo "ğŸŒ æœåŠ¡åœ°å€: http://${{ env.AWS_SERVER }}:8000"
        echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://${{ env.AWS_SERVER }}:8000/health"
        echo "ğŸ“Š ç›‘æ§æŒ‡æ ‡: http://${{ env.AWS_SERVER }}:8000/metrics"
        echo "ğŸ”— GitHub Webhook: http://${{ env.AWS_SERVER }}:8000/github_webhook"

        # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
        if curl -f -s http://${{ env.AWS_SERVER }}:8000/health >/dev/null; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
        else
          echo "âŒ éƒ¨ç½²å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"

          # è·å–è¯Šæ–­ä¿¡æ¯
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.AWS_SERVER }} "
            echo '=== æœåŠ¡çŠ¶æ€ ==='
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager || true
            echo '=== æœ€æ–°æ—¥å¿— ==='
            sudo journalctl -u ${{ env.SERVICE_NAME }} --no-pager -n 20 || true
          "
        fi
