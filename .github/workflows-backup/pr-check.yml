name: PR Pre-check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
    paths:
      - 'app/**'
      - 'tests/**'
      - 'Dockerfile*'
      - '.github/workflows/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-validation:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 pytest

      - name: Quick format check
        run: |
          echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
          black --check --diff .
          isort --check-only --diff .

      - name: Quick lint check
        run: |
          echo "ğŸ” å¿«é€Ÿä»£ç æ£€æŸ¥..."
          flake8 . --count --show-source --statistics --max-line-length=120

      - name: Quick test
        run: |
          echo "ğŸ§ª å¿«é€Ÿæµ‹è¯•..."
          pytest tests/ --maxfail=3 -q || echo "æµ‹è¯•å®Œæˆ"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install security tools
        run: |
          pip install detect-secrets bandit safety

      - name: Check for secrets
        run: |
          echo "ğŸ”’ æ£€æŸ¥å¯†é’¥æ³„éœ²..."
          detect-secrets scan --all-files \
            --exclude-files '\.git/.*' \
            --exclude-files '.mypy_cache/.*' \
            --exclude-files '.venv/.*' \
            --exclude-files '.*\.meta\.json$' \
            --exclude-files 'tests/.*\.py$' \
            --exclude-files '\.env$' \
            > pr-secrets-report.json || true

          # åªæ£€æŸ¥é«˜ç½®ä¿¡åº¦çš„å¯†é’¥
          if grep -q 'High' pr-secrets-report.json; then
            echo "âŒ å‘ç°é«˜ç½®ä¿¡åº¦å¯†é’¥æ³„éœ²"
            cat pr-secrets-report.json | grep -A5 -B5 'High'
            exit 1
          else
            echo "âœ… æœªå‘ç°å¯†é’¥æ³„éœ²"
          fi

      - name: Basic security scan
        run: |
          echo "ğŸ›¡ï¸ åŸºç¡€å®‰å…¨æ‰«æ..."
          bandit -r app/ -ll || echo "Bandit æ‰«æå®Œæˆ"

  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        run: |
          echo "ğŸ“‹ PR ä¿¡æ¯:"
          echo "- åˆ†æ”¯: ${{ github.head_ref }} -> ${{ github.base_ref }}"
          echo "- æäº¤: ${{ github.sha }}"
          echo "- ä½œè€…: ${{ github.actor }}"

          echo ""
          echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
          git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.sha }}

          echo ""
          echo "ğŸ“ å˜æ›´æ–‡ä»¶:"
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }}

      - name: Check commit messages
        run: |
          echo "ğŸ’¬ æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼..."
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆè§„èŒƒ
          git log --oneline -n 5

          # ç®€å•çš„æäº¤ä¿¡æ¯æ£€æŸ¥
          if git log --format=%s -n 1 | grep -E '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'; then
            echo "âœ… æäº¤ä¿¡æ¯æ ¼å¼æ­£ç¡®"
          else
            echo "âš ï¸ å»ºè®®ä½¿ç”¨è§„èŒƒçš„æäº¤ä¿¡æ¯æ ¼å¼: type(scope): description"
          fi

  size-check:
    name: Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file sizes
        run: |
          echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶å¤§å°..."

          # æ£€æŸ¥å¤§æ–‡ä»¶
          find . -type f -size +1M -not -path "./.git/*" -not -path "./.venv/*" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "âš ï¸ å¤§æ–‡ä»¶: $file ($size)"
          done

          # æ£€æŸ¥æ€»é¡¹ç›®å¤§å°
          total_size=$(du -sh . | cut -f1)
          echo "ğŸ“¦ é¡¹ç›®æ€»å¤§å°: $total_size"

      - name: Check line counts
        run: |
          echo "ğŸ“Š ä»£ç è¡Œæ•°ç»Ÿè®¡:"
          find . -name "*.py" -not -path "./.venv/*" -not -path "./.git/*" | xargs wc -l | tail -1

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Check requirements
        run: |
          echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–æ–‡ä»¶..."

          if [ -f requirements.txt ]; then
            echo "âœ… requirements.txt å­˜åœ¨"
            echo "ç”Ÿäº§ä¾èµ–æ•°é‡: $(wc -l < requirements.txt)"
          else
            echo "âŒ requirements.txt ä¸å­˜åœ¨"
          fi

          if [ -f requirements-dev.txt ]; then
            echo "âœ… requirements-dev.txt å­˜åœ¨"
            echo "å¼€å‘ä¾èµ–æ•°é‡: $(wc -l < requirements-dev.txt)"
          else
            echo "âš ï¸ requirements-dev.txt ä¸å­˜åœ¨"
          fi

      - name: Install and check dependencies
        run: |
          echo "ğŸ” æ£€æŸ¥ä¾èµ–å®‰è£…..."
          pip install -r requirements.txt
          pip check || echo "ä¾èµ–æ£€æŸ¥å®Œæˆ"

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [quick-validation, security-check, pr-info, size-check, dependency-check]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "ğŸ“‹ PR æ£€æŸ¥æ€»ç»“:"
          echo "================="

          if [ "${{ needs.quick-validation.result }}" == "success" ]; then
            echo "âœ… å¿«é€ŸéªŒè¯: é€šè¿‡"
          else
            echo "âŒ å¿«é€ŸéªŒè¯: å¤±è´¥"
          fi

          if [ "${{ needs.security-check.result }}" == "success" ]; then
            echo "âœ… å®‰å…¨æ£€æŸ¥: é€šè¿‡"
          else
            echo "âŒ å®‰å…¨æ£€æŸ¥: å¤±è´¥"
          fi

          echo ""
          echo "ğŸ’¡ ä¸‹ä¸€æ­¥:"
          echo "1. å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æ¨é€"
          echo "2. å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œç­‰å¾…å®Œæ•´ CI æµç¨‹"
          echo "3. ç¡®ä¿æ‰€æœ‰ CI æ£€æŸ¥é€šè¿‡åå†åˆå¹¶"
