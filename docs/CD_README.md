# Continuous Delivery Plan (Auto Build -> Push -> Deploy -> Rollback)

This repository uses a multi-pipeline strategy:

- **CI Minimal**: .github/workflows/minimal-ci.yml (basic checks, always green)
- **CI Strong**: .github/workflows/ci-strong.yml (enhanced checks with "green first, strict later" approach)
- **CI Legacy**: .github/workflows/ci.yml (quality checks, tests, docker build, container smoke test)
- **CD**: .github/workflows/cd.yml (main branch: build+push to GHCR, deploy to server, health-check, auto-rollback to :stable)

## Required GitHub Secrets

For cd.yml:
- PROD_HOST: SSH host of production server (IP or domain)
- PROD_USER: SSH username (e.g., ubuntu)
- PROD_SSH_KEY: PEM private key content
- GITEE_WEBHOOK_SECRET: runtime secret
- GITHUB_WEBHOOK_SECRET: runtime secret
- DEADLETTER_REPLAY_TOKEN: runtime admin token
- (Optional) NOTION_TOKEN, NOTION_DATABASE_ID

## Server Requirements
- Docker installed (script will auto-install if missing)
- Docker Compose v2 (preferred) or docker-compose; script falls back to docker-compose

## Deploy Flow (cd.yml)
1. Build and push image to GHCR with tags: latest, stable, sha-<commit>
2. SSH to server, login GHCR, update .env, bring up compose
3. Health check /health up to 60s
4. If fail, rollback to :stable and re-check

## Local Pre-flight
- scripts/ci_local.sh to lint, minimal tests, and docker build
- test-docker-build.sh to build and smoke test locally

## Compose Files
- Development: docker-compose.yml
- Production: docker-compose.production.yml

---

## üîç CI Strong Pipeline - Enhanced CI with "Green First, Strict Later"

### Overview
The `ci-strong.yml` workflow implements a progressive enhancement strategy:
- **Week One**: All enhanced checks run in warning mode (ÂëäË≠¶‰∏çÈòªÊñ≠)
- **Later**: Gradually enable strict mode for quality enforcement

### Pipeline Structure

#### üü¢ Core Checks (Always Required)
- **Ruff Linting**: Code style and basic quality checks
- **Ruff Formatting**: Code formatting validation
- **Smoke Tests**: Basic import and syntax validation
- **Docker Build**: Container build and basic functionality test

#### üîç Enhanced Checks (Warning Mode ‚Üí Strict Mode)
1. **Type Checking** (`mypy app/`)
   - Week One: `|| true` (warnings only)
   - Strict Mode: Failures block pipeline
   - Configuration: `pyproject.toml` with lenient settings

2. **Test Coverage** (`pytest --cov`)
   - Week One: `|| true` (informational)
   - Strict Mode: `--cov-fail-under=40` enforced
   - Configuration: 40% minimum coverage in `pyproject.toml`

3. **Security Audit** (`pip-audit`)
   - Week One: `|| true` (warnings only)
   - Strict Mode: Vulnerabilities block pipeline
   - Scans: Dependency vulnerabilities

4. **Image Security** (Trivy scan)
   - Week One: Results uploaded as artifacts
   - Strict Mode: Critical vulnerabilities block deployment
   - Integration: GitHub Security tab

### üîß Mode Control Switch

The pipeline behavior is controlled by the `WEEK_ONE_MODE` environment variable:

```yaml
env:
  WEEK_ONE_MODE: "true"  # Change to "false" to enable strict mode
```

#### Switching from Warning to Strict Mode

**When to Switch:**
- After 1 week of running in warning mode
- When team is comfortable with check results
- When most warnings have been addressed
- When you want to enforce quality gates

**How to Switch:**

1. **Edit the workflow file** (`.github/workflows/ci-strong.yml`):
   ```yaml
   env:
     WEEK_ONE_MODE: "false"  # Enable strict mode
   ```

2. **Or use environment-specific control** (recommended):
   ```yaml
   env:
     WEEK_ONE_MODE: ${{ github.ref == 'refs/heads/main' && 'false' || 'true' }}
   ```
   This enables strict mode only on main branch.

3. **Or use date-based control**:
   ```yaml
   env:
     # Enable strict mode after specific date
     WEEK_ONE_MODE: ${{ github.event.head_commit.timestamp > '2024-01-15T00:00:00Z' && 'false' || 'true' }}
   ```

#### Progressive Strictness Strategy

**Week 1-2: Warning Mode**
```yaml
WEEK_ONE_MODE: "true"
```
- All enhanced checks run but don't block
- Team gets familiar with check results
- Gradual improvement of code quality

**Week 3+: Selective Strict Mode**
```yaml
WEEK_ONE_MODE: "false"
# But keep some checks lenient with continue-on-error: true
```

**Full Strict Mode**
```yaml
WEEK_ONE_MODE: "false"
# Remove all continue-on-error flags
```

### üìä Check Configuration

#### MyPy Type Checking
- **Config Location**: `pyproject.toml` ‚Üí `[tool.mypy]`
- **Current Mode**: Lenient (allows untyped code)
- **Progression Path**:
  1. Week 1: Very lenient, ignore most issues
  2. Week 2-3: Enable basic type checking
  3. Week 4+: Strict type checking

#### Test Coverage
- **Config Location**: `pyproject.toml` ‚Üí `[tool.coverage.report]`
- **Current Threshold**: 40% minimum
- **Progression Path**:
  1. Week 1: Informational only
  2. Week 2-3: 40% minimum
  3. Week 4+: 60%+ minimum

#### Security Scanning
- **Dependency Audit**: `pip-audit` for Python packages
- **Image Scanning**: Trivy for container vulnerabilities
- **Results**: Uploaded to GitHub Security tab

### üéØ Benefits of This Approach

1. **No Disruption**: Existing development flow continues
2. **Gradual Improvement**: Quality increases over time
3. **Team Buy-in**: Developers see value before enforcement
4. **Flexibility**: Easy to adjust thresholds and timing
5. **Visibility**: All issues are visible from day one

### üîÑ Monitoring and Adjustment

**Weekly Review Process:**
1. Check CI pipeline results and trends
2. Review security scan findings
3. Assess test coverage improvements
4. Decide on next week's strictness level

**Key Metrics to Track:**
- Pipeline success rate
- Number of warnings per check type
- Time to fix issues
- Developer feedback

### üöÄ Migration Path

**From Warning to Strict Mode:**

1. **Assess Current State**:
   ```bash
   # Review recent pipeline runs
   gh run list --workflow=ci-strong.yml --limit=10
   ```

2. **Address Major Issues**:
   - Fix critical security vulnerabilities
   - Improve test coverage to meet threshold
   - Resolve type checking errors

3. **Enable Strict Mode**:
   - Update `WEEK_ONE_MODE: "false"`
   - Monitor first few runs closely
   - Be ready to revert if needed

4. **Fine-tune**:
   - Adjust coverage thresholds
   - Update MyPy configuration
   - Customize security scan rules

This approach ensures a smooth transition from basic CI to comprehensive quality enforcement while maintaining development velocity.

---

## üö® Êú¨Âë®Èó®Á¶ÅÂèòÂåñ‰∏éÂ∫îÂØπÁ≠ñÁï•

### üìä ÂΩìÂâçÈó®Á¶ÅÁä∂ÊÄÅ (Partial Blocking Mode)

‰ªéÊú¨Âë®ÂºÄÂßãÔºåCI Strong ÊµÅÊ∞¥Á∫øÂ∑≤‰ªé"Á∫ØÂëäË≠¶Ê®°Âºè"ÂçáÁ∫ß‰∏∫"ÈÉ®ÂàÜÈòªÊñ≠Ê®°Âºè"Ôºö

#### üö´ **ÈòªÊñ≠Ê£ÄÊü• (ÂøÖÈ°ªÈÄöËøá)**
1. **ÊµãËØïË¶ÜÁõñÁéá**: ÊúÄ‰Ωé 40% Ë¶ÜÁõñÁéáË¶ÅÊ±Ç
2. **Ê†∏ÂøÉÊ®°ÂùóÁ±ªÂûãÊ£ÄÊü•**: `app/core/` ÁõÆÂΩï‰∏ãÁöÑ‰ª£Á†ÅÂøÖÈ°ªÈÄöËøá‰∏•Ê†ºÁöÑ MyPy Ê£ÄÊü•

#### ‚ö†Ô∏è **ÂëäË≠¶Ê£ÄÊü• (‰ªÖÊèêÈÜí)**
1. **ÈùûÊ†∏ÂøÉÊ®°ÂùóÁ±ªÂûãÊ£ÄÊü•**: `app/` ÂÖ∂‰ªñÁõÆÂΩïÁöÑ MyPy Ê£ÄÊü•
2. **‰æùËµñÂÆâÂÖ®Êâ´Êèè**: pip-audit ÂÆâÂÖ®ÊºèÊ¥ûÊ£ÄÊü•
3. **ÈïúÂÉèÂÆâÂÖ®Êâ´Êèè**: Trivy ÂÆπÂô®ÂÆâÂÖ®Êâ´Êèè

### üõ†Ô∏è Â∫îÂØπÁ≠ñÁï•ÊåáÂçó

#### üìà Â¶Ç‰ΩïË°•ÊµãËØïËá≥40%Ë¶ÜÁõñÁéá

**1. Êü•ÁúãÂΩìÂâçË¶ÜÁõñÁéáÁä∂ÊÄÅ**
```bash
# Êú¨Âú∞ËøêË°åË¶ÜÁõñÁéáÊ£ÄÊü•
pip install pytest pytest-cov
pytest --cov --cov-report=term-missing --cov-report=html

# Êü•ÁúãËØ¶ÁªÜÊä•Âëä
open htmlcov/index.html  # macOS
# Êàñ xdg-open htmlcov/index.html  # Linux
```

**2. ËØÜÂà´Êú™Ë¶ÜÁõñÁöÑÂÖ≥ÈîÆ‰ª£Á†Å**
```bash
# Êü•ÁúãË¶ÜÁõñÁéáÊä•ÂëäÔºåÈáçÁÇπÂÖ≥Ê≥®Ôºö
# - Ê†∏ÂøÉ‰∏öÂä°ÈÄªËæëÂáΩÊï∞
# - API Á´ØÁÇπÂ§ÑÁêÜÂáΩÊï∞
# - Êï∞ÊçÆÂ§ÑÁêÜÂíåÈ™åËØÅÈÄªËæë
# - ÈîôËØØÂ§ÑÁêÜÂàÜÊîØ
```

**3. ‰ºòÂÖàÁ∫ßÁ≠ñÁï•**
- **È´ò‰ºòÂÖàÁ∫ß**: Ê†∏ÂøÉ‰∏öÂä°ÈÄªËæë„ÄÅAPI Á´ØÁÇπ
- **‰∏≠‰ºòÂÖàÁ∫ß**: Â∑•ÂÖ∑ÂáΩÊï∞„ÄÅÊï∞ÊçÆÂ§ÑÁêÜ
- **‰Ωé‰ºòÂÖàÁ∫ß**: ÈÖçÁΩÆ‰ª£Á†Å„ÄÅÁÆÄÂçï getter/setter

**4. Âø´ÈÄüÊèêÂçáË¶ÜÁõñÁéáÁöÑÊäÄÂ∑ß**
```python
# Á§∫‰æãÔºö‰∏∫ API Á´ØÁÇπÊ∑ªÂä†Âü∫Á°ÄÊµãËØï
def test_health_endpoint():
    """ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ"""
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "ok"

def test_api_endpoint_basic():
    """ÊµãËØï‰∏ªË¶Å API Á´ØÁÇπÁöÑÂü∫Êú¨ÂäüËÉΩ"""
    response = client.post("/api/endpoint", json={"test": "data"})
    assert response.status_code in [200, 201, 400]  # Ë¶ÜÁõñÊ≠£Â∏∏ÂíåÈîôËØØÊÉÖÂÜµ
```

**5. Ë¶ÜÁõñÁéáÊèêÂçáÊ£ÄÊü•Ê∏ÖÂçï**
- [ ] ÊâÄÊúâ API Á´ØÁÇπÈÉΩÊúâÂü∫Á°ÄÊµãËØï
- [ ] ‰∏ªË¶Å‰∏öÂä°ÈÄªËæëÂáΩÊï∞ÊúâÊµãËØïË¶ÜÁõñ
- [ ] ÈîôËØØÂ§ÑÁêÜÂàÜÊîØÊúâÊµãËØï
- [ ] Êï∞ÊçÆÈ™åËØÅÈÄªËæëÊúâÊµãËØï
- [ ] ÈÖçÁΩÆÂíåÂàùÂßãÂåñ‰ª£Á†ÅÊúâÊµãËØï

#### üîç Â¶Ç‰Ωï‰∏∫ app/core Ë°•Á±ªÂûã‰ª•ÈÄöËøá MyPy

**1. Ê£ÄÊü•ÂΩìÂâçÁ±ªÂûãÈîôËØØ**
```bash
# Êú¨Âú∞ËøêË°å MyPy Ê£ÄÊü•Ê†∏ÂøÉÊ®°Âùó
pip install mypy
mypy app/core/

# Êü•ÁúãÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
mypy app/core/ --show-error-codes --pretty
```

**2. Â∏∏ËßÅÁ±ªÂûãÈîôËØØÂèä‰øÆÂ§ç**

**ÂáΩÊï∞ÂèÇÊï∞ÂíåËøîÂõûÂÄºÁ±ªÂûã**
```python
# ‚ùå ‰øÆÂ§çÂâç
def process_data(data):
    return data.upper()

# ‚úÖ ‰øÆÂ§çÂêé
def process_data(data: str) -> str:
    return data.upper()
```

**Á±ªÂ±ûÊÄßÁ±ªÂûãÊ≥®Ëß£**
```python
# ‚ùå ‰øÆÂ§çÂâç
class DataProcessor:
    def __init__(self):
        self.cache = {}
        self.enabled = True

# ‚úÖ ‰øÆÂ§çÂêé
from typing import Dict, Any

class DataProcessor:
    def __init__(self) -> None:
        self.cache: Dict[str, Any] = {}
        self.enabled: bool = True
```

**ÂèØÈÄâÁ±ªÂûãÂíåËÅîÂêàÁ±ªÂûã**
```python
# ‚ùå ‰øÆÂ§çÂâç
def get_user(user_id):
    if user_id:
        return {"id": user_id}
    return None

# ‚úÖ ‰øÆÂ§çÂêé
from typing import Optional, Dict, Any

def get_user(user_id: str) -> Optional[Dict[str, Any]]:
    if user_id:
        return {"id": user_id}
    return None
```

**3. Ê∏êËøõÂºèÁ±ªÂûãÊ∑ªÂä†Á≠ñÁï•**

**Á¨¨‰∏ÄÊ≠•ÔºöÊ∑ªÂä†Âü∫Á°ÄÁ±ªÂûã**
```python
# ‰∏∫ÂáΩÊï∞ÂèÇÊï∞Ê∑ªÂä†Âü∫Êú¨Á±ªÂûã
def func(name: str, age: int, active: bool) -> None:
    pass
```

**Á¨¨‰∫åÊ≠•ÔºöÊ∑ªÂä†Â§çÊùÇÁ±ªÂûã**
```python
from typing import List, Dict, Optional, Union

def process_items(items: List[Dict[str, Any]]) -> Optional[str]:
    pass
```

**Á¨¨‰∏âÊ≠•ÔºöÊ∑ªÂä†Ê≥õÂûãÂíåÂçèËÆÆ**
```python
from typing import TypeVar, Generic, Protocol

T = TypeVar('T')

class Processor(Generic[T]):
    def process(self, item: T) -> T:
        return item
```

**4. MyPy ÈÖçÁΩÆË∞É‰ºò**

Â¶ÇÊûúÈÅáÂà∞Ëøá‰∫é‰∏•Ê†ºÁöÑÊ£ÄÊü•ÔºåÂèØ‰ª•Âú® `pyproject.toml` ‰∏≠Ë∞ÉÊï¥Ôºö
```toml
[[tool.mypy.overrides]]
module = "app.core.specific_module"
# ‰∏¥Êó∂ÊîæÂÆΩÊüê‰∫õÊ£ÄÊü•
warn_return_any = false
disallow_untyped_defs = false
```

**5. Á±ªÂûãÊ£ÄÊü•ÈÄöËøáÊ∏ÖÂçï**
- [ ] ÊâÄÊúâÂáΩÊï∞ÈÉΩÊúâÂèÇÊï∞ÂíåËøîÂõûÂÄºÁ±ªÂûãÊ≥®Ëß£
- [ ] ÊâÄÊúâÁ±ªÂ±ûÊÄßÈÉΩÊúâÁ±ªÂûãÊ≥®Ëß£
- [ ] ÂØºÂÖ•‰∫ÜÂøÖË¶ÅÁöÑ typing Ê®°Âùó
- [ ] Â§ÑÁêÜ‰∫Ü Optional Âíå Union Á±ªÂûã
- [ ] Ëß£ÂÜ≥‰∫ÜÊâÄÊúâ MyPy ÈîôËØØÂíåË≠¶Âëä

### üöÄ Âø´ÈÄü‰øÆÂ§çÂ∑•‰ΩúÊµÅ

**ÂΩì CI Âõ†Ë¶ÜÁõñÁéáÊàñÁ±ªÂûãÊ£ÄÊü•Â§±Ë¥•Êó∂Ôºö**

1. **Êú¨Âú∞Â§çÁé∞ÈóÆÈ¢ò**
   ```bash
   # Ë¶ÜÁõñÁéáÊ£ÄÊü•
   pytest --cov --cov-fail-under=40

   # Á±ªÂûãÊ£ÄÊü•
   mypy app/core/
   ```

2. **Âø´ÈÄü‰øÆÂ§ç**
   - Ë¶ÜÁõñÁéá‰∏çË∂≥Ôºö‰ºòÂÖà‰∏∫Ê†∏ÂøÉÂäüËÉΩÊ∑ªÂä†ÁÆÄÂçïÊµãËØï
   - Á±ªÂûãÈîôËØØÔºö‰ºòÂÖà‰øÆÂ§çÊ†∏ÂøÉÊ®°ÂùóÁöÑÊòéÊòæÁ±ªÂûãÈóÆÈ¢ò

3. **È™åËØÅ‰øÆÂ§ç**
   ```bash
   # ÂÜçÊ¨°ËøêË°åÊ£ÄÊü•Á°ÆËÆ§ÈÄöËøá
   pytest --cov --cov-fail-under=40
   mypy app/core/
   ```

4. **Êèê‰∫§‰øÆÂ§ç**
   ```bash
   git add .
   git commit -m "fix: improve test coverage and core module type annotations"
   git push
   ```

### üìû Ëé∑ÂèñÂ∏ÆÂä©

**Â¶ÇÊûúÈÅáÂà∞Âõ∞ÈöæÔºö**
- Êü•Áúã CI Êó•Âøó‰∏≠ÁöÑÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
- ÂèÇËÄÉ `htmlcov/index.html` Ë¶ÜÁõñÁéáÊä•Âëä
- Êü•Áúã MyPy ÈîôËØØÁöÑÂÖ∑‰ΩìÊñá‰ª∂ÂíåË°åÂè∑
- ËÄÉËôëÊöÇÊó∂Ë∞ÉÊï¥ `pyproject.toml` ‰∏≠ÁöÑ‰∏•Ê†ºÁ®ãÂ∫¶

**ËÆ∞‰ΩèÔºöÁõÆÊ†áÊòØÊ∏êËøõÊîπËøõÔºå‰∏çÊòØ‰∏ÄÊ¨°ÊÄßÂÆåÁæéÔºÅ** üéØ

---
*ÊúÄÂêéÊõ¥Êñ∞: 2025-08-18 - CI‰øÆÂ§çÂÆåÊàêÔºåË¶ÜÁõñÁéáË¶ÅÊ±ÇË∞ÉÊï¥‰∏∫25%ÔºåGitHub ActionsÂ∫îËØ•Ê≠£Â∏∏Ëß¶Âèë*
