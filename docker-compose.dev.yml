version: '3.8'

services:
  # ä¸»åº”ç”¨æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # å¦‚æœ Dockerfile æœ‰å¤šé˜¶æ®µæ„å»º
    container_name: github-notion-dev
    ports:
      - "8000:8000"
    volumes:
      # æŒ‚è½½æºä»£ç ä»¥æ”¯æŒçƒ­é‡è½½
      - .:/app
      - /app/.venv  # æ’é™¤è™šæ‹Ÿç¯å¢ƒç›®å½•
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    env_file:
      - .env.example  # ä½¿ç”¨ç¤ºä¾‹ç¯å¢ƒæ–‡ä»¶
    command: >
      sh -c "
        pip install -r requirements-dev.txt &&
        uvicorn app.server:app --reload --host 0.0.0.0 --port 8000
      "
    depends_on:
      - redis
      - postgres
    networks:
      - github-notion-dev

  # Redis æœåŠ¡ï¼ˆç”¨äºç¼“å­˜å’Œé˜Ÿåˆ—ï¼‰
  redis:
    image: redis:7-alpine
    container_name: github-notion-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - github-notion-dev

  # PostgreSQL æ•°æ®åº“ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
  postgres:
    image: postgres:15-alpine
    container_name: github-notion-postgres-dev
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=github_notion_dev
      - POSTGRES_USER=dev_user
      - POSTGRES_PASSWORD=dev_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - github-notion-dev

  # æµ‹è¯•æ•°æ®åº“
  postgres-test:
    image: postgres:15-alpine
    container_name: github-notion-postgres-test
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=github_notion_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    networks:
      - github-notion-dev

  # ä»£ç è´¨é‡æ£€æŸ¥æœåŠ¡
  quality-check:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: github-notion-quality
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        pip install -r requirements-dev.txt &&
        echo 'ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥...' &&
        make ci-local
      "
    networks:
      - github-notion-dev
    profiles:
      - quality  # ä½¿ç”¨ profile æ§åˆ¶æ˜¯å¦å¯åŠ¨

  # æ–‡æ¡£æœåŠ¡
  docs:
    image: squidfunk/mkdocs-material:latest
    container_name: github-notion-docs
    ports:
      - "8001:8000"
    volumes:
      - .:/docs
    command: serve --dev-addr=0.0.0.0:8000
    networks:
      - github-notion-dev
    profiles:
      - docs  # ä½¿ç”¨ profile æ§åˆ¶æ˜¯å¦å¯åŠ¨

volumes:
  redis_data:
    driver: local
  postgres_data:
    driver: local
  postgres_test_data:
    driver: local

networks:
  github-notion-dev:
    driver: bridge
